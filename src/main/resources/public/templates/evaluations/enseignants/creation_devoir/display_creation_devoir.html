<!--
  ~ Copyright (c) Région Hauts-de-France, Département 77, CGI, 2016.
  ~
  ~ This file is part of OPEN ENT NG. OPEN ENT NG is a versatile ENT Project based on the JVM and ENT Core Project.
  ~
  ~ This program is free software; you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation (version 3 of the License).
  ~ For the sake of explanation, any module that communicate over native
  ~ Web protocols, such as HTTP, with OPEN ENT NG is outside the scope of this
  ~ license and could be license under its own terms. This is merely considered
  ~ normal use of OPEN ENT NG, and does not fall under the heading of "covered work".
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  ~
  -->


<div class="addDevoir row twelve cell">
    <div class="eight cell twelve-mobile">
        <div class="pannel-in-cell">
            <tabs>
                <pane title="Informations évaluation">
                    <div class="row">
                        <form name="addDevoirForm" novalidate>
                            <div class="twelve cell addDevoirTable">

                                <!-- Etablissement -->
                                <section class="row twelve-mobile ">
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>viescolaire.utils.school</i18n>
                                        <i class="fa fa-asterisk obligatoire"></i>
                                    </div>

                                    <div class="nine cell twelve-mobile">
                                        <label class="select eight cell twelve-mobile">
                                            <select ng-model="devoir.id_etablissement" ng-change="updateEtabInfo()">
                                                <option ng-repeat="etab in me.structures" ng-selected="etab == me.structures[0]" value="[[etab]]">[[getEtablissementName(etab)]]</option>
                                            </select>
                                        </label>
                                    </div>
                                </section>

                                <!-- Classe -->
                                <section class="row twelve-mobile ">
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>viescolaire.utils.class.groupe</i18n>
                                        <i class="fa fa-asterisk obligatoire"></i>
                                    </div>

                                    <div class="nine cell twelve-mobile">
                                        <label class="select four twelve-mobile" ng-class="{disabled : devoir.id_etablissement === undefined}">
                                            <select ng-model="devoir.id_groupe" ng-change="setClasseMatieres();loadEnseignementsByClasse();" ng-options="classe.id as classe.name group by classe.type_groupe_libelle for classe in classes.all | orderBy:['type_groupe_libelle','name']">

                                            </select>
                                        </label>
                                    </div>
                                </section>

                                <!-- Matiere -->
                                <section class="row twelve-mobile">
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>viescolaire.utils.subject</i18n>
                                        <i class="fa fa-asterisk obligatoire"></i>
                                    </div>

                                    <div class="three cell twelve-mobile">
                                        <label class="select twelve-mobile" ng-class="{disabled : matieresFiltered.length == 0}">
                                            <select ng-model="devoir.id_matiere" ng-disabled="matieresFiltered.length == 0" ng-disabled="devoir.idEtablissement === undefined" ng-change="selectedMatiere()">
                                                <option ng-repeat="matiere in matieresFiltered = (matieres.all | getMatiereClasse:devoir.id_groupe:classes:search) | unique:'name'" ng-selected="matiere.id === devoir.id_matiere" value="[[matiere.id]]">[[matiere.name]]</option>
                                            </select>
                                        </label>
                                    </div>

                                    <!-- Sous matiere -->
                                    <div class="twelve-mobile " ng-if="devoir.matiere.sousMatieres.all.length !== 0">
                                        <div class="cell cell-indent addDevoirTable__libelle twelve-mobile">
                                            <i18n>viescolaire.utils.undersubject</i18n>
                                        </div>

                                        <div class="three cell twelve-mobile">
                                            <label class="select twelve-mobile" ng-class="{disabled : devoir.matiere === undefined || devoir.matiere.sousMatieres.all.length === 0}">
                                                <select ng-model="devoir.id_sousmatiere"  ng-disabled="devoir.matiere === undefined || devoir.matiere.sousMatieres.all.length === 0">
                                                    <option ng-repeat="sousMatiere in devoir.matiere.sousMatieres.all" ng-selected="sousMatiere.id == devoir.id_sousmatiere" value="[[sousMatiere.id]]">[[sousMatiere.libelle]]</option>
                                                </select>
                                            </label>
                                        </div>
                                    </div>
                                </section>

                                <!-- Type -->
                                <section class="row twelve-mobile">
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>viescolaire.utils.type</i18n>
                                        <i class="fa fa-asterisk obligatoire"></i>
                                    </div>

                                    <div class="nine cell twelve-mobile">
                                        <label class="select four twelve-mobile">
                                            <select ng-model="devoir.id_type">
                                                <option ng-repeat="type in types.all" ng-selected="type.default_type === true" value="[[type.id]]">[[type.nom]]</option>
                                            </select>
                                        </label>
                                    </div>
                                </section>

                                <div class="separator" />

                                <!-- Titre -->
                                <section class="row twelve-mobile">
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>evaluations.test.title</i18n>
                                        <i class="fa fa-asterisk obligatoire"></i>
                                    </div>

                                    <div class="nine cell twelve-mobile">
                                        <input type="text" class="eleven twelve-mobile" ng-model="devoir.name">
                                    </div>
                                </section>

                                <!-- Description -->
                                <section class="row twelve-mobile">
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>viescolaire.utils.description</i18n>
                                    </div>

                                    <div class="nine cell twelve-mobile">
                                        <textarea row="4" type="text" ng-model="devoir.libelle" class="eleven">
                                        </textarea>
                                    </div>
                                </section>

                                <div class="separator" />

                                <!-- Activer l'évaluation numérique ? -->
                                <section class="row twelve-mobile">
                                    <div class="three cell addDevoirTable__libelle pointer two-mobile" ng-click="devoir.is_evaluated = !devoir.is_evaluated">
                                        <label class="checkbox">
                                            <input type="checkbox" ng-model="devoir.is_evaluated">
                                            <span></span>
                                        </label>
                                    </div>

                                    <div class="nine cell ten-mobile indent-eight">
                                        <i18n>evaluations.test.is.evaluated</i18n>
                                    </div>
                                </section>

                                <div ng-if="devoir.is_evaluated">


                                    <!-- Noté sur -->
                                    <section style="padding: 10px 0;" class="row twelve-mobile">
                                        <div class="three cell addDevoirTable__libelle four-mobile">
                                            <i18n>evaluations.test.grade.on</i18n>
                                        </div>
                                        <div class="one cell addDevoirTable__libelle eight-mobile">
                                            <input type="number" class="eleven small-input-number three-mobile" ng-change="setRamenerSur()" ng-model="devoir.diviseur" min="0">
                                        </div>
                                    </section>

                                    <!-- Ramener sur 20 ? -->
                                    <section style="padding: 10px 0;" class="row twelve-mobile">
                                        <div class="cell addDevoirTable__libelle ten-mobile six">
                                            <i18n>evaluations.test.grade.report.average</i18n>
                                        </div>

                                        <div class="one cell addDevoirTable__libelle one-mobile" >
                                            <label class="checkbox">
                                                <input type="checkbox" ng-model="devoir.ramener_sur" ng-disabled="devoir.diviseur === 20" > <!-- ng-checked="devoir.diviseur !== 20" -->
                                                <span></span>
                                            </label>
                                        </div>
                                    </section>

                                    <!-- Coefficient -->
                                    <section style="padding: 10px 0;" class="row twelve-mobile">
                                        <div class="three cell addDevoirTable__libelle four-mobile">
                                            <i18n>viescolaire.utils.coefficient</i18n>
                                        </div>

                                        <div class="one cell addDevoirTable__libelle eight-mobile">
                                            <input  type="number" class="eleven small-input-number three-mobile" ng-model="devoir.coefficient" min="0">
                                        </div>
                                    </section>
                                </div>

                                <div class="separator" />

                                <section class="row twelve-mobile">
                                    <!-- Période -->
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>viescolaire.utils.periode</i18n>
                                        <i class="fa fa-asterisk obligatoire"></i>
                                    </div>

                                    <div class="nine cell twelve-mobile">
                                        <label class="select four twelve-mobile">
                                            <select ng-model="devoir.id_periode"
                                                    ng-options="periode.id as periode.libelle for periode in periodes.all">
                                            </select>
                                        </label>
                                    </div>
                                </section>

                                <section class="row twelve-mobile">
                                    <!-- Date évaluation -->
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>evaluations.test.date</i18n>
                                        <i class="fa fa-asterisk obligatoire"></i>
                                    </div>

                                    <div class="nine cell twelve-mobile">
                                        <date-picker style="margin: 10px 0;" ng-model="devoir.dateDevoir" class="four" ng-change="showDate = true; controleDate()" ></date-picker>
                                    </div>
                                </section>

                                <section class="row twelve-mobile">
                                    <!-- Date publication -->
                                    <div class="three cell addDevoirTable__libelle twelve-mobile">
                                        <i18n>evaluations.test.grade.publication.date</i18n>
                                        <i class="fa fa-asterisk obligatoire"></i>
                                    </div>

                                    <div class="nine cell twelve-mobile">
                                        <date-picker style="margin: 10px 0;" ng-model="devoir.datePublication" class="four" ng-change="showDate = true; controleDate()" ></date-picker>
                                    </div>
                                </section>

                            </div>
                        </form>
                    </div>
                </pane>
                <pane title="Compétences">
                    <h3><i18n>evaluations.test.competences</i18n> : </h3>

                    <!-- Recherche de competences -->
                    <div class="twelve cell twelve-mobile">
                        <input type="text" ng-model="search.keyword" placeholder="rechercher une compétence" style="width: 99%;font-size: 1em;font-style: italic;">
                    </div>

                    <!-- Filtre sur les enseignements -->
                    <div class="three cell twelve-mobile">

                        <!--<div class="row angle-container twelve-mobile">-->
                        <!--<button ng-click="deselectAllEnseignements()" style="height: 25px" class="instantButtons deselect right-magnet" tooltip="viescolaire.utils.deselectAll"></button>-->
                        <!--<button ng-click="selectAllEnseignements()" style="height: 25px" class="instantButtons select right-magnet" tooltip="viescolaire.utils.select.all"></button>-->
                        <!--</div>-->

                        <label class="chip multiselect right-magnet margin-left">
                            <span><i18n>viescolaire.utils.all.none</i18n></span>
                            <input type="checkbox" ng-model="bSelectAllEnseignements" ng-change="selectUnselectEnseignements()" ng-class="{ selected: bSelectAllEnseignements }"/>
                        </label>

                        <ul class="selectable-list twelve-mobile">
                            <li ng-repeat="enseignement in enseignements.all"
                                ng-class="{selected : enseignementsFilter[enseignement.id].isSelected}"
                                ng-click="enseignementsFilter[enseignement.id].isSelected = !enseignementsFilter[enseignement.id].isSelected">
                                [[enseignement.nom]]
                            </li>
                        </ul>
                    </div>

                    <!-- Competences filtrees / recherchees -->

                    <div class="nine cell twelve-mobile">

                        <!--
                            function-filter : méthode qui va checker si l'enseignement parcouru doit être affiché ou non
                            function-search : méthode qui va déplier les enseignements/compétences qui matche le mot clef recherché. Cette méthode surligne
                            également les mots recherchés
                            data : les enseignements parcourus
                            enseignements-filter : objet où l'on stocke si un enseignement est sélectionné ou non
                            competences-filter : objet où l'on stocke les noms au format html des compétences (pour le surlignement lors d'une recherche)
                            search : objet concernant la recherche
                        -->
                        <c-skills-list devoir="devoir" function-filter="enseignementsFilterFunction"
                                       function-search="enseignementsSearchFunction"
                                       data="devoir.enseignements"
                                       enseignements-filter="enseignementsFilter"
                                       competences-filter="competencesFilter"
                                       search="search"
                                       devoir-competences="evaluations.competencesDevoir">

                        </c-skills-list>
                    </div>

                </pane>
            </tabs>

        </div>

        <div class="twelve cell">
            <input class="button-add-devoir " type="button" ng-click="beforSaveDevoir()" ng-disabled="controleNewDevoirForm()" i18n-value="viescolaire.utils.save">
        </div>

    </div>

    <input class="button-add-devoir zero-mobile button-fixed-top-right" type="button" ng-click="beforSaveDevoir()" ng-disabled="controleNewDevoirForm()" i18n-value="viescolaire.utils.save">


    <!-- PARTIE RECAPITULATIF -->
    <div class="ten-mobile four cell fixed-top-right">
        <div class="twelve-mobile pannel-in-cell">
            <h2 class="eight cell twelve-mobile"><i18n>evaluations.devoir.recaputilatif</i18n></h2>

            <div class="devoir-recapitulatif twelve-mobile">

                <!-- Titre devoir-->
                <section>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">evaluations.test.title</i18n>
                        <div class="twelve-mobile inline-block six">[[devoir.name]]</div>
                    </div>
                </section>

                <!-- Description devoir-->
                <section>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">viescolaire.utils.description</i18n>
                        <div class="twelve-mobile inline-block six word-break"> [[devoir.libelle]]</div>
                    </div>
                </section>

                <!-- Etablissement devoir-->
                <section>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">viescolaire.utils.school</i18n>
                        <div class="twelve-mobile inline-block six" ng-if="devoir.id_etablissement !== null">[[getEtablissementName(devoir.id_etablissement)]]</div>
                    </div>
                </section>

                <!-- Classe devoir-->
                <section>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">viescolaire.utils.class</i18n>
                        <div class="twelve-mobile inline-block six">[[getClasseData(devoir.id_groupe, 'name')]]</div>
                    </div>
                </section>

                <!-- Matiere/Sous matiere devoir-->
                <section>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">viescolaire.utils.subject</i18n>
                        <div class="twelve-mobile inline-block six" ng-if="devoir.id_matiere !== null">[[getLibelleMatiere(devoir.id_matiere)]]</div>
                    </div>
                    <div class="twelve-mobile inline-block twelve" ng-show="devoir.id_sousmatiere !== null"><i18n class="bold cell">viescolaire.utils.undersubject</i18n>
                        <div class="twelve-mobile inline-block six">[[getLibelleSousMatiere(devoir.id_sousmatiere)]]</div>
                    </div>
                </section>

                <!-- Coefficient / Note sur -->
                <section ng-if="devoir.is_evaluated">
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">viescolaire.utils.coefficient</i18n>
                        <div class="twelve-mobile inline-block six">[[devoir.coefficient]]</div>
                    </div>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">evaluations.test.grade.on</i18n>
                        <div class="twelve-mobile inline-block six">[[devoir.diviseur]]</div>
                    </div>
                </section>

                <!-- Checkbox ramener les notes sur 20 -->
                <section ng-if="devoir.is_evaluated">
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">evaluations.test.grade.report.average.shortlibelle</i18n>
                        <div class="twelve-mobile inline-block six checkbox">
                            <input type="checkbox" ng-model="devoir.ramener_sur" disabled="disabled" > <!-- ng-checked="devoir.diviseur !== 20" -->
                            <span></span>
                        </div>
                    </div>
                </section>

                <!-- Periode / Type devoir-->
                <section>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">viescolaire.utils.periode</i18n>
                        <div class="twelve-mobile inline-block six">[[getLibellePeriode(devoir.id_periode)]]</div>
                    </div>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">viescolaire.utils.type</i18n>
                        <div class="twelve-mobile inline-block six">[[getLibelleType(devoir.id_type)]]</div>
                    </div>
                </section>

                <!-- Date evaluation -->
                <section>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">evaluations.test.date</i18n>
                        <div class="twelve-mobile inline-block six">[[getDateFormated(devoir.dateDevoir)]]</div>
                    </div>
                </section>

                <!-- Date de publication de la note -->
                <section>
                    <div class="twelve-mobile inline-block twelve"><i18n class="bold cell">evaluations.test.grade.publication.date.shortlibelle</i18n>
                        <div class="twelve-mobile inline-block six">[[getDateFormated(devoir.datePublication)]]</div>
                    </div>
                </section>

                <section class="separator"></section>

                <!-- Competences selectionnees sur le devoir -->
                <section>
                    <ul class="twelve twelve-mobile devoir-skills-list">
                        <li ng-repeat="itemCompetence in evaluations.competencesDevoir" class="skills-connaissance">
                            <label class="skills-label twelve-mobile">
                                <!--<span class="skill-connaissance-eye fa fa-eye"></span>-->
                                <span ng-class="{whiteSpaceNormal : itemCompetence.hoveringRecap}"
                                      ng-mouseenter="showIt(itemCompetence)"
                                      ng-mouseleave="hideIt(itemCompetence)"
                                      class="eleven skills-list-connaissance skills-text-overflow italic" title="Connaissance">
                                    [[buildCompetenceNom(itemCompetence)]]
                                </span>
                            </label>
                        </li>
                    </ul>
                </section>

            </div>
        </div>

    </div>
</div>

<lightbox  show="opened.lightboxs.updateDevoir.firstConfirmSupp" on-close="opened.lightboxs.updateDevoir.firstConfirmSupp = false">
    <p><i18n>evaluations.devoir.updateDevoir.firstConfirmSupp.part1</i18n></p>
    <div ng-if="(evaluatedCompetencesSupp.length < 15)">
        <p><i18n>evaluations.devoir.recaputilatif</i18n>:</p>
        <ul>
            <li ng-repeat="competence in evaluatedCompetencesSupp">[[competence.nom]]</li>
        </ul>
    </div>
    <p><i18n>evaluations.devoir.updateDevoir.firstConfirmSupp.part2</i18n></p>

    <button class="marginFive" ng-click="ConfirmeUpdateDevoir()">
        <i18n>evaluations.devoir.confirmation</i18n>
    </button>
    <button class="marginFive" ng-click="cancelUpdateDevoir()">
        <i18n>evaluations.devoir.annuler</i18n>
    </button>
</lightbox>

<lightbox  show="opened.lightboxs.updateDevoir.secondConfirmSupp" on-close="opened.lightboxs.updateDevoir.secondConfirmSupp = false ">
    <p><i18n>evaluations.devoir.updateDevoir.secondConfirmSupp.part1</i18n></p>
    <button class="marginFive" ng-click="ConfirmeUpdateDevoir()">
        <i18n>evaluations.devoir.confirmation</i18n>
    </button>
    <button class="marginFive" ng-click="cancelUpdateDevoir()">
        <i18n>evaluations.devoir.annuler</i18n>
    </button>
</lightbox>

<lightbox  show="opened.lightboxs.updateDevoir.evaluatedSkillDisabel" on-close="opened.lightboxs.updateDevoir.evaluatedSkillDisabel = false ">
    <p><i18n>evaluations.devoir.updateDevoir.evaluatedSkillDisabel.part1</i18n></p>
    <button class="marginFive" ng-click="ConfirmeUpdateDevoir()">
        <i18n>evaluations.devoir.confirmation</i18n>
    </button>
    <button class="marginFive" ng-click="cancelUpdateDevoir()">
        <i18n>evaluations.devoir.annuler</i18n>
    </button>
</lightbox>